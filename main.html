<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.3/xlsx.full.min.js"></script>
  <title>BPO Agent Breaks Dashboard</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .container {
      flex: 1;
    }

    #signatureFooter {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #f8f9fa;
      padding: 10px;
      text-align: center;
      font-weight: bold;
    }

    #logo {
      max-width: 100px;
      max-height: 100px;
    }
  </style>
</head>
<body>

  <div class="container">
    <img src="app_logo.png" alt="Logo" id="logo">
    <h1>Break Smart Pro</h1>

    <div class="input-field">
      <select id="breakTypeDropdown">
        <option value="system_issue">System Issue (20 minutes)</option>
        <option value="lunch">Lunch (30 minutes)</option>
        <option value="bio_break">Bio Break (15 minutes)</option>
        <option value="tea">Tea (15 minutes)</option>
        <option value="tl_briefing">TL Briefing (60 minutes)</option>
        <option value="er_hr_briefing">ER/HR Briefing (30 minutes)</option>
        <option value="quality_briefing">Quality Briefing (60 minutes)</option>
        <option value="training">Training (30 minutes)</option>
      </select>
      <label for="breakTypeDropdown">Select Break Type</label>
    </div>

    <div class="row">
      <div class="col s6">
        <canvas id="pieChart"></canvas>
        <p id="piePercentage" class="center-align"></p>
      </div>
      <div class="col s6">
        <canvas id="barChart"></canvas>
        <p id="barPercentage" class="center-align"></p>
      </div>
    </div>

    <div class="input-field">
      <button class="btn waves-effect waves-light" onclick="startStopwatch()">Start Break Stopwatch</button>
      <button class="btn waves-effect waves-light red" onclick="stopBreak()">Stop Break</button>
      <div id="stopwatch" class="center-align" style="margin-top: 10px;"></div>
      <div id="breakStatus" class="center-align" style="margin-top: 10px;"></div>
    </div>

    <button class="btn waves-effect waves-light" onclick="calculateBreaks()">Calculate Breaks</button>

    <button class="btn waves-effect waves-light" onclick="exportToExcel()">Export to Excel</button>

    <div id="signatureFooter" class="center-align" style="margin-top: 20px;">Made by Atharv Joshi - Truly Dynamic</div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    let stopwatchInterval;
    let remainingTime;
    let breakActive = false;
    let breakStartTime;
    let breakEndTime;

    // Mapping break duration to break type
    const breakDurationMap = {
      system_issue: 20,
      lunch: 30,
      bio_break: 15,
      tea: 15,
      tl_briefing: 60,
      er_hr_briefing: 30,
      quality_briefing: 60,
      training: 30,
    };

    $(document).ready(function(){
      $('select').formSelect();
    });

    function calculateBreaks() {
      const breakType = $('#breakTypeDropdown').val();
      const pieChartCanvas = document.getElementById('pieChart');
      const barChartCanvas = document.getElementById('barChart');
      const piePercentage = document.getElementById('piePercentage');
      const barPercentage = document.getElementById('barPercentage');

      // Use the selected break type to get the corresponding break duration
      const breakDuration = breakDurationMap[breakType];

      // Simulate break data for the selected type
      const breakData = generateBreakData(breakType, breakDuration);

      // Calculate total break time
      const totalBreakTime = breakData.reduce((total, breakRecord) => total + breakRecord.duration, 0);

      // Update pie chart
      renderPieChart(pieChartCanvas, breakData);
      piePercentage.innerText = `Total: ${totalBreakTime} minutes`;

      // Update bar chart
      renderBarChart(barChartCanvas, breakData, breakType);
      barPercentage.innerText = `Total: ${totalBreakTime} minutes`;

      // Reset stopwatch
      clearInterval(stopwatchInterval);
      remainingTime = 0;
      breakActive = false;
      updateStopwatch();
      updateBreakStatus();
    }

    function updateStopwatch() {
      const minutes = Math.floor(remainingTime / 60);
      const seconds = remainingTime % 60;
      const formattedTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      $('#stopwatch').text(`Time remaining: ${formattedTime}`);

      if (remainingTime === 0) {
        clearInterval(stopwatchInterval);
        breakActive = false;
        updateBreakStatus();
      } else {
        remainingTime--;
      }
    }

    function updateBreakStatus() {
      const breakStatus = document.getElementById('breakStatus');
      breakStatus.innerText = breakActive ? 'Break in progress' : 'No active break';
    }

    function exportToExcel() {
      const breakType = $('#breakTypeDropdown').val();
      const breakDuration = breakDurationMap[breakType];
      const breakData = generateBreakData(breakType, breakDuration);
      
      // Add elapsed time and exceeded time to break data
      const currentUser = getCurrentUser();
      breakData[0].elapsedTime = Math.floor((breakEndTime - breakStartTime) / 1000 / 60);
      breakData[0].exceededTime = Math.max(breakData[0].elapsedTime - breakData[0].duration, 0);
      breakData[0].username = currentUser.username;

      // Get existing user-specific break data from local storage
      const existingBreakData = getUserBreakData();

      // Append new break data to the existing data
      const updatedBreakData = [...existingBreakData, breakData[0]];

      // Save updated break data to local storage
      setUserBreakData(updatedBreakData);

      const worksheet = XLSX.utils.json_to_sheet(updatedBreakData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'BreakData');
      XLSX.writeFile(workbook, 'break_data.xlsx');
    }
  </script>
</body>
</html>
